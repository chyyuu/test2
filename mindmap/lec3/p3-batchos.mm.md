### 第三节: 实践：批处理操作系统
- 实验目标
  - 让APP与OS隔离
  - 自动加载并运行多个程序
  - 理解特权级和特权级切换
  - 实现系统调用
- 实践步骤
  - 构造包含OS和多个APP的单一执行镜像
  - 通过批处理支持多个APP的自动加载和运行
  - 利用硬件特权级机制实现对操作系统自身的保护
  - 支持跨特权级的系统调用
  - 实现特权级的切换
- 软件架构
  - 构建应用
    - 把多个应用合在一起与OS形成一个二进制镜像
  - 改进OS
    - 加载和执行程序、特权级上下文切换
  - 系统调用设计
    - 设计支持系统调用的库
- 相关硬件
  - RISC-V陷入(trap)类指令
    - ecall 和 ebreak
  - 特权指令
    - sret
  - 异常向量表
    - 描述各种异常类型和代码
- 应用程序设计
  - 应用与底层支撑库分离
  - 引入外部库
  - 设计支撑库
    - 定义用户库的入口点 _start
  - 内存布局
    - 设计应用程序的内存布局
  - 系统调用
    - 应用程序的系统调用执行流
    - 系统调用封装和参数传递
- 内核程序设计
  - 应用管理和加载
    - 将应用程序映像链接到内核
    - 应用程序管理数据结构
    - 加载应用程序二进制码
  - 特权级切换
    - 特权级切换相关CSR
    - 特权级切换后的硬件逻辑
    - 返回用户态让应用执行
  - Trap处理
    - Trap上下文数据结构
    - 保存Trap上下文
    - 调用trap_handler
    - 恢复Trap上下文
  - 执行应用程序
    - 应用程序的执行时机
    - 让应用程序执行
    - 切换到下一个应用程序


### 第四节 支持文件的操作系统 (Filesystem OS)

- 实验目标
  - 当前实验目标：支持数据持久保存
  - 以文件形式保存持久数据，并进行文件数据读写
  - 进程成为文件资源的使用者
  - 系统调用：open/read/write/close
- 实验要求
    - 理解文件系统/文件概念
    - 理解文件系统的设计与实现
    - 理解应用至库至设备驱动的完整文件访问过程
    - 能编写支持文件系统的OS
- 需要考虑的问题
    - 文件系统在硬盘上如何组织？硬盘布局？
    - 如何管理空闲磁盘块？
    - 文件/目录的表示方法？
    - 文件/目录数据内容的表示？
    - 如何访问一个文件？
- 总体思路
    - 存储设备上的文件系统和文件
    - OS管理的内存中的文件系统和文件
    - 二者的关联关系
- 文件系统接口和数据结构
    - 文件访问流程图
      - 初始化：文件系统，磁盘外设
      - 初始化：确定文件系统根节点
      - 对用户进程的服务：根据文件名，从根节点出发，找到目录项和对应的inode
      - 对用户进程的服务：根据inode进行文件读写  
    - 文件系统访问接口（自上而下）
      - syscall interface
      - 进程：fd_table interface
      - VFS
      - easyfs
      - BlkCacahe
      - BlkDriver
    - 文件系统的数据结构
      - PCB: fd_table[fd] --> OSInode 
      - VFS：OSInode --> DiskInode
      - EasyFS：DiskInode --> BlkCache
      - BlkCache：BlkCache --> BlkDevice
      - BlkDevice：read_block()/write_block() --> Disk
- 实验步骤
    - 编译：内核独立编译，单独的内核镜像
    - 编译：应用程序编译后，组织形成文件系统镜像
    - 构造：进程的管理与初始化，建立基于页表机制的虚存空间
    - 构造：构建文件系统
    - 运行：特权级切换，进程与OS相互切换
    - 运行：切换地址空间，跨地址空间访问数据
    - 运行：从文件系统加载应用，形成进程
    - 运行：数据访问：内存--磁盘，基于文件的读写
- 代码结构
    - 分析新增和改进的模块
      - easy-fs和其构成
      - OS中与文件/文件系统相关的修改部分
        - 与加载文件相关的修改
      - 存储块设备驱动（基本了解其功能即可）
- 应用程序设计
    - 文件和目录
      - 从应用和内核两个角度来理解
    - 文件访问系统调用：open, close, read, write
      - 从进程和文件系统两个角度来理解
      - 从进程和文件系统二者在文件访问上的联系来分析
- 内核程序设计
    - 核心数据结构
      - 进程管理文件
        - DirEntry
        - OSInode
        - fd_table
      - 文件系统管理 
        - superblock
        - inode/data bitmap
        - disk_inode
        - disk_data
        - blk_cache
    - 文件管理机制
      - 文件系统初始化
      - 基于文件加载应用
      - 打开/关闭文件
      - 读/写文件




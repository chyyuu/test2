### 第三节 实践：支持device的OS（DOS）

- 进化目标 vs 以往目标
  - SMOS：在多线程中支持对共享资源的同步互斥访问
  - TCOS：支持线程和协程 
  - IPC OS：进程间交互
  - Filesystem OS：支持数据持久保存
  - Process OS: 增强进程管理和资源管理
  - Address Space OS: 隔离APP访问的内存地址空间
  - multiprog & time-sharing OS: 让APP共享CPU资源
  - BatchOS：让APP与OS隔离，加强系统安全，提高执行效率
  - LibOS: 让APP与HW隔离，简化应用访问硬件的难度和复杂性
  - DOS需求：需要支持对多种外设的高效访问
- 实践：DOS
  - 同学的进化目标
    - 了解设备与CPU的交互关系
    - 理解如何在内核中响应中断
    - 理解驱动的基本管理过程
    - 理解驱动的基本设计思路
    - 理解驱动与内核其它部分的交互
    - 会写支持多种外设的OS
- 历史背景
  - UNIX诞生是从磁盘驱动程序开始的
  - 写磁盘驱动程序包括：数据结构、初始化、中断响应、设备操作、内部交互
- 相关硬件
  - PLIC(平台级中断控制器)
  - CLINT(核心局部中断器)
  - 系统中的外设
    - UART设备
    - virtio-blk磁盘块设备
    - virtio-input 键盘设备
    - virtio-gpu 显示设备
- 总体思路
  - 外设中断
    - 提高系统的整体执行效率
    - 在内核态响应外设中断以提高OS对外设IO请求的响应速度
    - 潜在问题：内核态能响应中断后，不能保证对全局变量的互斥访问
    - 解决方案：在访问全局变量起始前屏蔽中断，结束后使能中断 
- 实践步骤
  - 示例代码库 setup
- 软件架构
  - 内核的主要修改详述
- 程序设计
  - 设备直接相关操作：初始化、中断处理、I/O读写
  - OS交互相关需求：内存服务、中断/调度服务等




